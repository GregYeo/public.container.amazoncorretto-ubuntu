name: Build container image

on:
  push:
  pull_request:

jobs:
  build-and-push-platform:
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
            platform-tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            platform-tag: linux-arm64
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    env:
      COMPOSE_FILE: 'compose.yml:compose.build.yml'
    steps:
      - name: Collect Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@v2
        with:
          comment_on_pr: true

      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract repo name
        id: repo_name_step
        run: |
          REPO_LOWERCASE=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          echo "repo_name=ghcr.io/$REPO_LOWERCASE" >> $GITHUB_OUTPUT

      - name: Build and Test with Compose
        env:
          REPO_NAME: ${{ steps.repo_name_step.outputs.repo_name }}
          VERSION_TAG: ${{ github.sha }}
          PLATFORM_TAG: ${{ matrix.platform-tag }}
        run: |
          docker compose build
          docker compose up

      - name: Push to GHCR
        if: success()
        env:
          REPO_NAME: ${{ steps.repo_name_step.outputs.repo_name }}
          VERSION_TAG: ${{ github.sha }}
          PLATFORM_TAG: ${{ matrix.platform-tag }}
        run: |
          docker compose push

  create-manifest:
    name: Create Multi-arch Manifest
    runs-on: ubuntu-latest
    needs: build-and-push-platform
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract repo name
        id: repo_name_step
        run: |
          REPO_LOWERCASE=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          echo "repo_name=ghcr.io/$REPO_LOWERCASE" >> $GITHUB_OUTPUT

      - name: Extract Tag or SHA
        id: vars
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            # Use short SHA (7 characters) for cleaner tags
            echo "version=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Discover and Create Multi-arch Manifests
        env:
          REPO_NAME: ${{ steps.repo_name_step.outputs.repo_name }}
          VERSION_TAG: ${{ github.sha }}
          NAMED_VERSION: ${{ steps.vars.outputs.version }}
        run: |
         SERVICES=$(docker compose config --services)
          
          for SERVICE in $SERVICES; do
            echo "--- Creating Manifest for: $SERVICE ($VERSION) ---"
      
            AMD64_SOURCE="$REPO_NAME:$SERVICE-$VERSION_TAG-linux-amd64"
            ARM64_SOURCE="$REPO_NAME:$SERVICE-$VERSION_TAG-linux-arm64"
            
            # The final clean multi-arch tags
            docker buildx imagetools create \
              -t "$REPO_NAME:$SERVICE-$VERSION_TAG" \
              -t "$REPO_NAME:$SERVICE-$NAMED_VERSION" \
              "$AMD64_SOURCE" \
              "$ARM64_SOURCE"
          done